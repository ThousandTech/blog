<!-- extends表明此页面继承自 base.html 文件 -->
{% extends "base.html" %}
{% load staticfiles %}

<!-- 写入 base.html 中定义的 title -->
{% block title %}
    {{ article.title }}
{% endblock title %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/article/detail.css' %}">
{% endblock extra_css %}

<!-- 写入 base.html 中定义的 content -->
{% block content %}
<!-- 文章详情 -->
<div class="container">
    <div class="row">
        <!-- 标题及作者 -->
        <div class="col-12 col-md-10 {% if 'li' in toc %}offset-md-2{% else %}offset-md-1{% endif %}">
            <h1 class="mt-4 mb-4">{{ article.title }}</h1>
            {% if article.column or article.tags.all %}
            <div class="tag-row mb-3">
                {% if article.column %}
                    <span class="text-muted">分类：</span>
                    {% widthratio article.column.id 1 60 as hue %}
                    <a href="{% url 'article:article_list' %}?column={{ article.column.id }}" 
                        class="btn btn-sm column-tag"
                        style="--hue: {{ hue }};"
                    >
                        {{ article.column }}
                    </a>
                {% endif %}

                {% if article.tags.all %}
                    <span class="text-muted ml-2">标签：</span>
                {% endif %}
                {% for tag in article.tags.all %}
                    <a href="{% url 'article:article_list' %}?tag={{ tag.name|urlencode }}" 
                        class="badge badge-secondary"
                    >
                        {{ tag }}
                    </a>
                {% empty %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="alert alert-success">
                <div>
                    作者：{{ article.author }}
                    {% if user == article.author or user.is_superuser %}
                        · <a href="{% url "article:article_update" article.id %}">
                            编辑文章
                        </a>
                        · <a href="#" data-action="article-delete">删除文章</a>
                    {% endif %}
                </div>
                <div>
                    浏览：{{ article.total_views }}
                </div>
                <!-- 11 隐藏的安全删除表单 -->
                <form 
                    style="display:none;" 
                    id="safe_delete"
                    action="{% url 'article:article_safe_delete' article.id %}" 
                    method="POST"
                    >
                    {% csrf_token %}
                    <button type="submit">发送</button>
                </form>
            </div>
        </div>

        <!-- 目录 -->
        {% if 'li' in toc %}
        <div class="col-12 col-md-2" id="sidebar" class="sidebar">
            <div class="sidebar-sticky">
                <hr class="mt-0">
                <h4 class="text-center d-none d-md-block"><strong>目录</strong></h4>
                
                <!-- 移动端目录折叠按钮 -->
                <button class="btn btn-secondary d-md-none mb-3 w-100" type="button" data-toggle="collapse" data-target="#tocCollapse" aria-expanded="false" aria-controls="tocCollapse">
                    查看目录
                </button>

                <hr class="d-none d-md-block">
                
                <div id="tocCollapse" class="collapse d-md-block">
                    {{ toc|safe }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 文章正文 -->
        <div class="col-12 col-md-10 {% if 'li' not in toc %}offset-md-1{% endif %} article-content"> 
            {{ article.body|safe }}
        </div>

        <!-- 发表评论 -->
        <div class="col-12 col-md-10 {% if 'li' in toc %}offset-md-2{% else %}offset-md-1{% endif %}">
            <hr>
            {% if user.is_authenticated %}
                <div>
                    <form 
                        action="{% url 'comment:post_comment' article.id %}" 
                        method="POST"
                    >
                    {% csrf_token %}
                        <div class="form-group">
                            <label for="body">
                                <strong>
                                    评论：
                                </strong>
                            </label>
                            <textarea 
                                type="text" 
                                class="form-control" 
                                id="body" 
                                name="body" 
                                rows="2"></textarea>
                        </div>
                        <!-- 提交按钮 -->
                        <button type="submit" class="btn btn-primary ">发送</button>                    
                    </form>
                </div>
                <br>
            {% else %}
                <br>
                <h5 class="row justify-content-center">
                    请<a href="{% url 'userprofile:login' %}">登录</a>后回复
                </h5>
                <br>
            {% endif %}
            
            <!-- 显示评论 -->
            <h4>共有{{ comments.count }}条评论</h4>
            <div>
                {% for comment in comments %}
                    <hr>
                    <p class="comment-meta">
                        <strong class="comment-user">
                            {{ comment.user }}
                        </strong> 于 
                        <span class="comment-time">
                            {{ comment.created|date:"Y-m-d H:i:s" }}
                        </span> 时发表：
                    </p>
                    <pre class="comment-body">{{ comment.body }}</pre>
                    {% if user == comment.user or user == article.author or user.is_superuser %}
                        <p>
                            <a href="#" data-action="comment-delete" data-comment-id="{{ comment.id }}">删除</a>
                            <form 
                                style="display:none;" 
                                id="safe_delete_comment_{{ comment.id }}" 
                                action="{% url 'comment:delete_comment' comment.id %}" 
                                method="POST"
                            >
                                {% csrf_token %}
                                <button type="submit">发送</button>
                            </form>
                        </p>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock content %}
{% block extra_js %}
    <script src="{% static 'js/article/detail.js' %}"></script>
{% endblock extra_js %}
