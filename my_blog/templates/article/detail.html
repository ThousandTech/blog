<!-- extends表明此页面继承自 base.html 文件 -->
{% extends "base.html" %}
{% load staticfiles %}

<!-- 写入 base.html 中定义的 title -->
{% block title %}
    {{ article.title }}
{% endblock title %}

<!-- 写入 base.html 中定义的 content -->
{% block content %}
<style> 
    .sidebar-sticky div > ul {
         padding-left: 20px;
    }
    .sidebar-sticky ul ul {
        padding-left: 1.2em;
    }
    .sidebar-sticky a {
        color: #0056b3;
    }
    .sidebar-sticky a:hover {
        color: black;
    }
    /* 侧边栏及目录样式结束 */
    
    /* 文章样式 */
    /* 标题换行 */
    h1 {
        word-break: break-all;
    }
    /* 正文换行 */
    .article-content {
        word-break: break-all;
    }
    /* 代码块不换行，保持水平滚动 */
    .article-content pre {
        word-break: normal;
        overflow-x: auto;
    }
    /* 图片自适应 */
    .article-content img {
        max-width: 100%;
        height: auto;
    }
</style>

<!-- 文章详情 -->
<div class="container">
    <div class="row">
        <!-- 标题及作者 -->
        <div class="col-12 col-md-10 {% if 'li' in toc %}offset-md-2{% else %}offset-md-1{% endif %}">
            <h1 class="mt-4 mb-4">{{ article.title }}</h1>
            <div class="alert alert-success">
                <div>
                    作者：{{ article.author }}
                    {% if user == article.author or user.is_superuser %}
                        · <a href="{% url "article:article_update" article.id %}">
                            编辑文章
                        </a>
                        · <a href="#" onclick="confirm_delete()">删除文章</a>
                    {% endif %}
                </div>
                <div>
                    浏览：{{ article.total_views }}
                </div>
                <!-- 11 隐藏的安全删除表单 -->
                <form 
                    style="display:none;" 
                    id="safe_delete"
                    action="{% url 'article:article_safe_delete' article.id %}" 
                    method="POST"
                    >
                    {% csrf_token %}
                    <button type="submit">发送</button>
                </form>
            </div>
        </div>

        <!-- 目录 -->
        {% if 'li' in toc %}
        <div class="col-12 col-md-2" id="sidebar" class="sidebar">
            <div class="sidebar-sticky">
                <hr class="mt-0">
                <h4 class="text-center d-none d-md-block"><strong>目录</strong></h4>
                
                <!-- 移动端目录折叠按钮 -->
                <button class="btn btn-secondary d-md-none mb-3 w-100" type="button" data-toggle="collapse" data-target="#tocCollapse" aria-expanded="false" aria-controls="tocCollapse">
                    查看目录
                </button>

                <hr class="d-none d-md-block">
                
                <div id="tocCollapse" class="collapse d-md-block">
                    {{ toc|safe }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 文章正文 -->
        <div class="col-12 col-md-10 {% if 'li' not in toc %}offset-md-1{% endif %} article-content"> 
            {{ article.body|safe }}
        </div>

        <!-- 发表评论 -->
        <div class="col-12 col-md-10 {% if 'li' in toc %}offset-md-2{% else %}offset-md-1{% endif %}">
            <hr>
            {% if user.is_authenticated %}
                <div>
                    <form 
                        action="{% url 'comment:post_comment' article.id %}" 
                        method="POST"
                    >
                    {% csrf_token %}
                        <div class="form-group">
                            <label for="body">
                                <strong>
                                    评论：
                                </strong>
                            </label>
                            <textarea 
                                type="text" 
                                class="form-control" 
                                id="body" 
                                name="body" 
                                rows="2"></textarea>
                        </div>
                        <!-- 提交按钮 -->
                        <button type="submit" class="btn btn-primary ">发送</button>                    
                    </form>
                </div>
                <br>
            {% else %}
                <br>
                <h5 class="row justify-content-center">
                    请<a href="{% url 'userprofile:login' %}">登录</a>后回复
                </h5>
                <br>
            {% endif %}
            
            <!-- 显示评论 -->
            <h4>共有{{ comments.count }}条评论</h4>
            <div>
                {% for comment in comments %}
                    <hr>
                    <p>
                        <strong style="color: pink">
                            {{ comment.user }}
                        </strong> 于 
                        <span style="color: green">
                            {{ comment.created|date:"Y-m-d H:i:s" }}
                        </span> 时发表：
                        
                        {% if user == comment.user or user == article.author or user.is_superuser %}
                            <a href="#" onclick="confirm_delete_comment('{{ comment.id }}')">删除</a>
                            <form 
                                style="display:none;" 
                                id="safe_delete_comment_{{ comment.id }}" 
                                action="{% url 'comment:delete_comment' comment.id %}" 
                                method="POST"
                            >
                                {% csrf_token %}
                                <button type="submit">发送</button>
                            </form>
                        {% endif %}
                    </p>
                    <pre style="font-family: inherit; font-size: 1em; white-space: pre-wrap; word-break: break-all;">{{ comment.body }}</pre>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // 24 删除评论的函数
    function confirm_delete_comment(comment_id) {
        layer.open({
            title: "确认删除",
            content: "确认删除该评论吗？",
            yes: function(index, layero) {
                $('form#safe_delete_comment_' + comment_id + ' button').click();
                layer.close(index);
            }
        })
    }

    // 11 删除文章的函数原始版
    function confirm_delete() {
        // 调用layer弹窗组件
        layer.open({
            // 弹窗标题
            title: "确认删除",
            // 正文
            content: "确认删除这篇文章吗？",
            // 点击确定按钮后调用的回调函数
            yes: function(index, layero) {
                // 指定应当前往的 url
                // location.href='{#% url "article:article_delete" article.id %#}';
                alert("请使用安全删除功能");
            },
        })
    }
    // 11 删除文章的函数安全版
    function confirm_safe_delete() {
    layer.open({
        title: "确认删除",
        content: "确认删除这篇文章吗？",
        yes: function(index, layero) {
            $('form#safe_delete button').click();
            layer.close(index);
        }
    })
}
</script>

{% endblock content %}