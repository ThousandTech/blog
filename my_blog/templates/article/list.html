<!-- 07 extends表明此页面继承自 base.html 文件，会加载base.html中的内容之后填充base.html的定义块 -->
{% extends "base.html" %}

{% load staticfiles %}

<!-- 07 写入 base.html 中定义的 title -->
{% block title %}
    Thousand的个人站
{% endblock title %}

<!-- 07 写入 base.html 中定义的 content -->
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/echarts@4/dist/echarts.min.js"></script>
<style>
    :root {
        --bg: #0f1216;
        --surface: #151a21;
        --surface-soft: #1c222b;
        --border: #252c35;
        --text: #e8ecf1;
        --muted: #9aa3b0;
        --accent: #7cc5ff;
        --success: #9fe870;
        --sidebar-width: 280px;
        --profile-card-height: 260px;
    }

    html {
        overflow-y: scroll;
    }

    body {
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    a {
        color: var(--accent);
    }

    a:hover {
        color: #b2ddff;
    }

    .layout-shell {
        padding: 28px 0 32px;
        flex: 1;
    }

    .custom-container {
        padding-left: 12px;
        padding-right: 12px;
        margin-left: 0;
        margin-right: 0;
        max-width: 100%;
        overflow-x: hidden;
    }

    .content-grid {
        display: grid;
        grid-template-columns: var(--sidebar-width) minmax(0, 1fr) var(--sidebar-width);
        gap: 24px;
        align-items: start;
    }

    .card-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px 20px;
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.3);
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .profile-card {
        min-height: var(--profile-card-height);
    }

    .sidebar-placeholder {
        height: calc(var(--profile-card-height) * 1.5);
    }

    .profile-card .avatar-circle {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        margin: 0 auto;
        background: linear-gradient(135deg, #78ffd6, #7cc5ff);
        display: grid;
        place-items: center;
        color: #0c0f14;
        font-weight: 700;
        font-size: 28px;
    }

    .profile-card .stat-number {
        font-weight: 700;
        font-size: 18px;
    }

    .profile-card .stat-label {
        color: var(--muted);
        font-size: 12px;
    }

    .social-links {
        gap: 16px;
    }

    .social-icon {
        color: var(--muted);
        transition: color 0.2s ease;
    }

    .social-icon:hover {
        color: var(--accent);
    }

    .category-list li {
        margin-bottom: 8px;
    }

    .category-btn {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: var(--surface-soft);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .category-btn:hover {
        background: #2a3240;
        color: var(--accent);
        text-decoration: none;
        border-color: #343e4f;
    }

    .category-btn .category-count {
        background: #3b4558;
        color: #dfe6f1;
        padding: 2px 8px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 12px;
    }

    .feed-nav {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 16px;
    }

    .feed-nav .breadcrumb {
        background: transparent;
        padding: 0;
        margin: 0;
    }

    .feed-nav .breadcrumb-item a {
        color: var(--text);
        font-weight: 600;
    }

    .feed-nav .breadcrumb-item a.text-muted {
        color: var(--muted) !important;
    }

    .feed-nav .breadcrumb-item + .breadcrumb-item::before {
        content: '';
        padding: 0;
    }

    .feed-tab {
        padding: 6px 14px;
        border-radius: 12px;
        text-decoration: none;
        display: inline-block;
        color: var(--muted);
        transition: all 0.2s ease;
    }

    .feed-tab:hover {
        color: #b2ddff;
        text-decoration: none;
    }

    .feed-tab.active {
        background: var(--accent);
        color: #0c0f14 !important;
        font-weight: 700;
        pointer-events: none;
    }

    .feed-search input {
        background: var(--surface-soft);
        border: 1px solid var(--border);
        color: var(--text);
    }

    .feed-search input::placeholder {
        color: #6f7783;
    }

    .feed-search .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #0c0f14;
        font-weight: 600;
    }

    .article-card {
        margin-bottom: 16px;
    }

    .article-card h4 {
        margin-bottom: 10px;
    }

    .article-card .article-title a {
        color: var(--text);
        text-decoration: none;
        display: inline-block;
        max-width: 100%;
    }

    .article-card .article-title a:hover {
        color: var(--accent);
    }

    .article-meta {
        color: var(--muted);
        font-size: 14px;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .article-meta span + span {
        margin-left: 12px;
    }

    .badge-secondary {
        background-color: #2d3847;
        color: var(--text);
        border: 1px solid #3d4a5d;
        transition: all 0.2s ease;
        padding: 6px 12px;
        border-radius: 8px;
    }

    .badge-secondary:hover {
        background-color: var(--accent);
        color: #0c0f14;
        text-decoration: none;
        border-color: var(--accent);
    }

    .gap-2 {
        gap: 8px;
    }

    .pagination .btn {
        border-radius: 10px;
    }

    .pagination-row {
        margin-top: 12px;
        margin-bottom: 0;
    }

    /* Color article tags per column using a hue derived from the column id */
    .column-tag {
        color: hsl(var(--hue, 210), 60%, 20%);
        background-color: hsl(var(--hue, 210), 70%, 88%);
        border-color: hsl(var(--hue, 210), 70%, 76%);
        font-weight: 600;
    }

    .column-tag:hover {
        color: hsl(var(--hue, 210), 60%, 16%);
        background-color: hsl(var(--hue, 210), 70%, 84%);
        border-color: hsl(var(--hue, 210), 70%, 70%);
    }

    @media (max-width: 992px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        .feed-search input {
            max-width: 160px;
        }
    }

    /* Monitor Styles */
    .metric-bar {
        height: 18px;
        background-color: var(--surface-soft);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }
    .metric-bar-fill {
        height: 100%;
        width: 0%;
        display: block; /* changed from flex */
        background-color: transparent; /* color set by JS */
        transition: width 0.4s ease, background-color 0.4s ease;
    }
    .metric-text-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between; /* changed from flex-start to space-between */
        padding-left: 6px;
        padding-right: 6px; /* added right padding */
        font-size: 10px;
        color: #ffffff;
        text-shadow: 0 0 2px rgba(0,0,0,0.8), 0 0 4px rgba(0,0,0,0.6); /* Text shadow for contrast */
        pointer-events: none; /* Let clicks pass through */
        z-index: 10;
    }
    .net-indicator {
        font-size: 0.85em;
    }
    .net-up {
        color: #c0504d;
    }
    .net-down {
        color: #4f81bd;
    }
</style>

<div class="layout-shell">
    <div class="container-fluid custom-container">
        <div class="content-grid">
            <!-- 左侧：个人信息 + 分类 -->
            <aside class="sidebar-left">
                <div class="card-panel profile-card text-center mb-3">
                    <div class="avatar-circle">
                        {% if profile_user.profile.avatar %}
                            <img src="{{ profile_user.profile.avatar.url }}" alt="{{ profile_user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <span>{{ profile_user.username|default:"T"|slice:":1"|upper }}</span>
                        {% endif %}
                    </div>
                    <h5 class="mt-3 mb-1">{{ profile_user.username|default:"Thousand" }}</h5>
                    <p class="text-muted mb-3">{{ profile_user.profile.bio|default:"Glad to meet you here, this is Thousand." }}</p>
                    <div class="social-links d-flex justify-content-center gap-3">
                        <a href="https://github.com/ThousandTech" target="_blank" class="social-icon" title="GitHub">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                            </svg>
                        </a>
                        <a href="https://space.bilibili.com/452909274" target="_blank" class="social-icon" title="哔哩哔哩">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/>
                            </svg>
                        </a>
                        <a href="mailto:{{ profile_user.email|default:'contact@example.com' }}" class="social-icon" title="邮箱">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </a>
                    </div>
                </div>

                <div class="card-panel category-card mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">分类</h6>
                    </div>
                    <ul class="list-unstyled mb-0 category-list">
                        <li>
                            <a href="?column=uncategorized&order={{ order }}" 
                               class="category-btn">
                                <span>未分类</span>
                                <span class="category-count">{{ uncategorized_count }}</span>
                            </a>
                        </li>
                        {% for col in columns %}
                            <li>
                                <a href="?column={{ col.id }}&order={{ order }}" 
                                   class="category-btn">
                                    <span>{{ col.title }}</span>
                                    <span class="category-count">{{ col.article.count }}</span>
                                </a>
                            </li>
                        {% empty %}
                            <li class="text-muted small">暂无分类</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="card-panel category-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">标签</h6>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in all_tags %}
                            <a href="?tag={{ tag.name|urlencode }}" class="badge badge-secondary" style="font-size: 12px; padding: 6px 12px;">
                                {{ tag }}
                            </a>
                        {% empty %}
                            <p class="text-muted small">暂无标签</p>
                        {% endfor %}
                    </div>
                </div>
            </aside>

            <!-- 中间：文章列表 -->
            <main class="main-feed">
                <div class="card-panel feed-nav">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb align-items-center flex-nowrap mb-0">
                            <li class="breadcrumb-item" style="font-size: 1.1rem;">
                                <a href="{% url 'article:article_list' %}?search={{ search }}&column={{ column }}&tag={{ tag }}"
                                   class="feed-tab {% if order == 'normal' %}active{% endif %}">
                                    最新
                                </a>
                            </li>
                            <li class="breadcrumb-item" style="font-size: 1.1rem;">
                                <a href="{% url 'article:article_list' %}?order=total_views&search={{ search }}&column={{ column }}&tag={{ tag }}"
                                   class="feed-tab {% if order == 'total_views' %}active{% endif %}">
                                    最热
                                </a>
                            </li>
                        </ol>
                    </nav>

                    <form class="form-inline feed-search" >
                        <div class="input-group">
                            <input type="text" 
                                class="form-control" 
                                name="search" 
                                placeholder="搜索文章..."
                                value="{{ search }}"
                            >
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit">搜索</button>
                            </div>
                        </div>
                    </form>
                </div>

                {% if search %}
                    {% if articles %}
                        <div class="card-panel mb-3" style="color: var(--muted);">
                            <strong>“{{ search }}”</strong> 的搜索结果如下：
                        </div>
                    {% else %}
                        <div class="card-panel mb-3" style="color: var(--muted);">
                            暂无 “{{ search }}” 相关的文章。
                        </div>
                    {% endif %}
                {% endif %}

                {% for article in articles %}
                    <div class="card-panel article-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                {% if article.column %}
                                    {% widthratio article.column.id 1 60 as hue %}
                                    <a href="{% url 'article:article_list' %}?column={{ article.column.id }}" 
                                        class="btn btn-sm column-tag"
                                        style="--hue: {{ hue }};"
                                    >
                                        {{ article.column }}
                                    </a>
                                {% endif %}
                                {% for tag in article.tags.all %}
                                    <a href="{% url 'article:article_list' %}?tag={{ tag.name|urlencode }}" 
                                    class="badge badge-secondary"
                                    >
                                        {{ tag }}
                                    </a>
                                {% endfor %}
                            </div>
                            <span class="article-meta">{{ article.updated|date:'Y-m-d' }} 更新</span>
                        </div>

                        <h4 class="article-title">
                            <a href="{% url 'article:article_detail' article.id %}">
                                {{ article.title }}
                            </a>
                        </h4>

                        <p class="article-meta">{{ article.body|slice:'120' }}...</p>

                        <div class="article-meta mt-2">
                            <span>{{ article.total_views }} 浏览</span>
                            <span>{{ article.created|date:'Y-m-d' }} 发布</span>
                        </div>
                    </div>
                {% endfor %}

                <!-- 页码导航 -->
                {% if articles.paginator.num_pages > 1 %}
                <div class="pagination row pagination-row">
                    <div class="m-auto">
                        <span class="step-links">
                            {% if articles.has_previous %}
                                <a href="?page=1&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}" class="btn btn-success">&laquo; 1</a>
                                <span class="text-muted">...</span>
                                <a href="?page={{ articles.previous_page_number }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}" 
                                class="btn btn-secondary"
                                >
                                    {{ articles.previous_page_number }}
                                </a>
                            {% endif %}

                            <span class="btn btn-primary btn-lg">
                                {{ articles.number }}
                            </span>

                            {% if articles.has_next %}
                                <a href="?page={{ articles.next_page_number }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                                class="btn btn-secondary">{{ articles.next_page_number }}</a>
                                <span class="text-muted">...</span>
                                <a href="?page={{ articles.paginator.num_pages }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                                class="btn btn-success">{{ articles.paginator.num_pages }} &raquo;</a>
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}
            </main>

            <!-- 右侧预留区域：空白块与左栏同宽，高为个人信息卡片的1.5倍 -->
            <aside class="sidebar-right d-none d-lg-block">
                <div class="card-panel mb-3" id="earth-time-panel">
                    <h5 class="mb-3">地球</h5>
                    <div class="monitor-info">
                        <div class="d-flex justify-content-between mb-0">
                            <span>标准时间</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="utc-time" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span>本地时间</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="local-time" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>
                    </div>
                </div>

                <div class="card-panel mb-3" id="admin-status-panel">
                    <h5 class="mb-3">管理员</h5>
                    <div id="admin-status-content">
                        <div class="d-flex justify-content-between mb-0">
                            <span>状态(根据终端使用情况推测)</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span class="small" id="admin-state-text" style="font-size: 0.85rem;">检测中...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span>运行时长</span>
                        </div>
                        <div class="mt-1">
                            <span class="text-muted small" id="live-time" style="font-size: 0.85rem; color: #9aa3b0 !important;"></span>
                        </div>
                    </div>
                </div>

                <div class="card-panel mb-3" id="terminal-status-panel">
                    <h5 class="mb-3">通讯终端</h5>
                    <div id="terminal-status-content">
                        <p class="text-muted small">正在获取数据...</p>
                    </div>
                </div>

                <div class="card-panel mb-3">
                    <h5 class="mb-3">服务器</h5>
                    
                    <div class="monitor-info mb-3">
                        <div class="d-flex justify-content-between mb-0">
                            <span>系统版本</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="system-version" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>

                        <div class="d-flex justify-content-between mb-0">
                            <span>主机名</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="hostname" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>

                        <div class="d-flex justify-content-between mb-0">
                            <span>CPU</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="cpu-name" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>

                        <div class="d-flex justify-content-between mb-0">
                            <span>运行时长</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <span id="uptime" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">...</span>
                        </div>
                    </div>

                    <div class="monitor-metric mb-3">
                        <div class="d-flex justify-content-between mb-0">
                            <span>CPU使用率</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <div class="metric-bar">
                                <div id="cpu-bar" class="metric-bar-fill"></div>
                                <div class="metric-text-overlay">
                                    <span id="cpu-percent-text">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-metric mb-3">
                        <div class="d-flex justify-content-between mb-0">
                            <span>内存使用率</span>
                        </div>
                        <div class="mt-1 mb-2">
                            <div class="metric-bar">
                                <div id="mem-bar" class="metric-bar-fill"></div>
                                <div class="metric-text-overlay">
                                    <span id="mem-percent-text">0%</span>
                                    <span id="mem-usage-text">0G/0G</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-chart mb-3">
                        <div class="d-flex justify-content-between mb-0">
                            <span>磁盘 I/O</span>
                        </div>
                        <div class="mt-1 mb-2 position-relative">
                            <div class="position-absolute" style="top: 0; right: 0; z-index: 10;">
                                <span id="disk-r-indicator" class="net-indicator net-up mr-2 small" style="font-size: 0.85rem;"></span>
                                <span id="disk-w-indicator" class="net-indicator net-down small" style="font-size: 0.85rem;"></span>
                            </div>
                            <div id="disk-chart" style="width: 100%; height: 120px;"></div>
                        </div>
                    </div>

                    <div class="monitor-chart">
                        <div class="d-flex justify-content-between mb-0">
                            <span>网络流量</span>
                        </div>
                        <div class="mt-1 mb-2 position-relative">
                            <div class="position-absolute" style="top: 0; right: 0; z-index: 10;">
                                <span id="net-up-indicator" class="net-indicator net-up mr-2 small" style="font-size: 0.85rem;"></span>
                                <span id="net-down-indicator" class="net-indicator net-down small" style="font-size: 0.85rem;"></span>
                            </div>
                            <div id="network-chart" style="width: 100%; height: 120px;"></div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

{% include 'monitor/script.html' %}

<script>
    function updateLiveTime() {
        const birthTime = new Date(2004, 8, 18, 15, 30, 0); // 月份从0开始，8表示9月
        const now = new Date();
        
        let years = now.getFullYear() - birthTime.getFullYear();
        let months = now.getMonth() - birthTime.getMonth();
        let days = now.getDate() - birthTime.getDate();
        let hours = now.getHours() - birthTime.getHours();
        let minutes = now.getMinutes() - birthTime.getMinutes();
        let seconds = now.getSeconds() - birthTime.getSeconds();
        
        // 处理负数情况
        if (seconds < 0) {
            seconds += 60;
            minutes--;
        }
        if (minutes < 0) {
            minutes += 60;
            hours--;
        }
        if (hours < 0) {
            hours += 24;
            days--;
        }
        if (days < 0) {
            const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
            days += lastMonth.getDate();
            months--;
        }
        if (months < 0) {
            months += 12;
            years--;
        }
        
        const timeStr = `${years}y ${months}m ${days}d ${hours}h ${minutes}m ${seconds}s`;
        document.getElementById('live-time').textContent = timeStr;
    }
    
    updateLiveTime();
    setInterval(updateLiveTime, 1000);

    // Terminal Status Polling
    let terminalUpTime = null;
    let isTerminalOffline = false;

    function formatUptime(seconds) {
        if (seconds === null || seconds === undefined) return '-';
        const days = Math.floor(seconds / (3600 * 24));
        const hours = Math.floor((seconds % (3600 * 24)) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        let result = '';
        if (days > 0) result += `${days}d `;
        if (hours > 0) result += `${hours}h `;
        result += `${minutes}m `;
        result += `${secs}s`;
        return result;
    }

    function tickTerminalTime() {
        if (terminalUpTime !== null && !isTerminalOffline) {
            terminalUpTime++;
            const el = document.getElementById('terminal-uptime');
            if (el) {
                el.textContent = formatUptime(terminalUpTime);
            }
        }
    }
    setInterval(tickTerminalTime, 1000);

    function updateTerminalStatus() {
        fetch('/article/terminal-latest/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const contentDiv = document.getElementById('terminal-status-content');
                if (data.error) {
                    contentDiv.innerHTML = '<p class="text-muted small">暂无数据</p>';
                    return;
                }
                
                terminalUpTime = data.up_time;
                isTerminalOffline = data.is_offline;

                let statusText = data.is_charging ? '充电中' : '在线';
                let statusColor = data.is_charging ? 'var(--success)' : 'var(--accent)';
                let timeDisplay = data.created;

                if (data.is_offline) {
                    statusText = '离线';
                    statusColor = 'var(--muted)';
                }
                
                // 推测管理员状态
                let adminState = '空闲或摆烂';
                let adminColor = 'var(--success)';
                
                // busy_time 是未使用手机休闲应用的累计时间
                // 未使用时间较长认为是忙碌
                if (data.busy_time > 900) {
                    adminState = '忙碌或昏迷';
                    adminColor = 'var(--accent)';
                }

                if (data.is_offline) {
                    adminState = '失联';
                    adminColor = 'var(--muted)';
                }

                document.getElementById('admin-state-text').textContent = adminState;
                document.getElementById('admin-state-text').style.color = adminColor;

                // 计算颜色渐变
                function getBatteryColor(percent) {
                    // 定义起始颜色 (绿色 #9fe870) 和结束颜色 (红色 #e63946)
                    // 使用 HSL 色彩空间进行计算可能更自然，这里简单使用 RGB 插值
                    // #9fe870 = rgb(159, 232, 112)
                    // #ff6b6b (柔和红) = rgb(255, 107, 107)
                    
                    const startR = 255, startG = 107, startB = 107; // 红色 (低电量)
                    const endR = 159, endG = 232, endB = 112;     // 绿色 (高电量)
                    
                    const ratio = percent / 100;
                    
                    const r = Math.round(startR + (endR - startR) * ratio);
                    const g = Math.round(startG + (endG - startG) * ratio);
                    const b = Math.round(startB + (endB - startB) * ratio);
                    
                    return `rgb(${r}, ${g}, ${b})`;
                }
                
                let batteryColor = getBatteryColor(data.percent);
                let batteryText = `${data.percent}%`;
                let batteryWidth = data.percent;
                
                if (data.is_offline) {
                    batteryColor = 'var(--muted)';
                    batteryText = 'NaN';
                    batteryWidth = 0;
                }

                contentDiv.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span>电量</span>
                        <span style="color: ${batteryColor}; font-weight: bold;">${batteryText}</span>
                    </div>
                    <div class="progress mb-3" style="height: 6px; background-color: rgba(127, 127, 127, 0.3);">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${batteryWidth}%; background-color: ${batteryColor};" 
                             aria-valuenow="${batteryWidth}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>

                    <div class="d-flex justify-content-between mb-0">
                        <span>状态</span>
                    </div>
                    <div class="mt-1 mb-2">
                        <span class="text-muted small" style="font-size: 0.85rem; color: ${statusColor} !important;">${statusText}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-0">
                        <span>运行时长</span>
                    </div>
                    <div class="mt-1 mb-2">
                        <span id="terminal-uptime" class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">${formatUptime(data.up_time)}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-0">
                        <span>${data.is_offline ? '最后上报时间' : '更新时间'}</span>
                    </div>
                    <div class="mt-1">
                        <span class="text-muted small" style="font-size: 0.85rem; color: #9aa3b0 !important;">${timeDisplay} (UTC+8)</span>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error fetching terminal status:', error);
            });
    }

    // Update immediately and then every 3 seconds
    updateTerminalStatus();
    setInterval(updateTerminalStatus, 60000);
</script>
{% endblock content %}
